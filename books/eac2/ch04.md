# CH04 上下文相关分析 (Context-Sensitive Analysis)

- [4.1 简介](#41-简介)
- [4.2 类型系统简介](#42-类型系统简介)
  - [4.2.1 类型系统的目标](#421-类型系统的目标)
  - [4.2.2 类型系统的组件](#422-类型系统的组件)
- [4.3 属性语法框架](#43-属性语法框架)
  - [4.3.1 求值的方法](#431-求值的方法)
  - [4.3.2 环](#432-环)
  - [4.3.3 扩展实例](#433-扩展实例)
  - [4.3.4 属性语法方法的问题](#434-属性语法方法的问题)
- [4.4 特设语法制导转换](#44-特设语法制导转换)
  - [4.4.1 特设语法制导转换的实现](#441-特设语法制导转换的实现)
  - [4.4.2 例子](#442-例子)
- [4.5 高级主题](#45-高级主题)
  - [4.5.1 类型推断中更困难的问题](#451-类型推断中更困难的问题)
  - [4.5.2 改变结合性](#452-改变结合性)
- [4.6 小结和展望](#46-小结和展望)

## 4.1 简介

编译器的最终任务是将输入程序转换为一种可以直接在目标机上执行的形式。为此，它对输入程序的了解要远超过语法这个层次。对于输入程序中编码的计算过程的细节，编译器必须建立一个庞大的知识库。编译器必须了解输入程序表示了哪些值、这些值驻留在何处、值是如何从一个名字流动到另一个名字的。它必须理解计算过程本身的结构。它必须分析程序与外部文件和设备的交互方式。利用上下文知识，所有这些事实都可以从源代码推导出来。因而，与词法分析器或语法分析器通常所做的工作相比，编译器必须进行更深入的分析。

这种分析或者与语法分析并行不悖地进行，或者在语法分析之后地一趟处理中进行（遍历语法分析器生成的 IR）。我们将这种分析称为“上下文分析”（context-sensitive analysis），以区别语法分析，或者称为“语义推敲”（semantic
elaboration），因为它对 IR 进行了推敲加工。

## 4.2 类型系统简介

- 类型：一种抽象范畴，规定了其所有成员共有的性质。

程序设计语言中类型的集合，以及使用类型来规定程序行为的规则，总称为类型系统（type system）。

### 4.2.1 类型系统的目标

- 确保运行时的安全性
  - 类型推断、隐式转换、强类型语言
- 提高表达力
  - 运算符重载
- 生成更好的代码
- 类型检查

### 4.2.2 类型系统的组件

- 基础类型
  - 数字、字符、布尔值
- 复合类型和构造类型
  - 数组、串、枚举类型、结构和变体、指针
- 类型等价性
  - 名字等价性、结构等价性
- 用于推断的规则
  - 声明和推断
- 推断表达式的类型
- 类型推断的过程间相关问题

## 4.3 属性语法框架

属性语法（attribute grammar）是用于上下文相关分析的一种形式化机制，也称为属性化的上下文无关语法（attributed context-free grammar）。

### 4.3.1 求值的方法

- 动态方法
- 无关方法
- 基于规则的方法

### 4.3.2 环

有环的属性语法会导致有环的属性依赖图。在依赖关系图包含环时，我们的求值模型会失败。

处理环：

- 避免
- 求值

实际上，大部分属性语法系统都仅关注无环语法。

### 4.3.3 扩展实例

- 推断表达式类型
- 一个简单的执行时间估算器
- 改进执行代价估算器
- 回到表达式推断的主题
- 对执行代价估算器的最终改进

### 4.3.4 属性语法方法的问题

- 处理非局部信息
- 存储管理
- 语法分析树的实例化
- 确定答案
- 对功能范型的突破

## 4.4 特设语法制导转换

属性语法的基于规则的求值程序引入了一种强大的思想，许多编译器中用于上下文相关分析的特设技术就是在此基础上发展而来的。在基于规则的求值程序中，编译器编写者规定一系列操作，关联到语法中的产生式。其本质是上下文分析所需的操作可以围绕着语法的结构进行组织，由此产生了一种强大的特设方法，用以将此类分析集成到解析上下文无关语法的过程中。我们将这种方法称为特设语法制导转换（ad hoc syntax-directed translation）。

### 4.4.1 特设语法制导转换的实现

- 操作之间的通信
- 值的引用
- 语法分析过程中其他位置处执行的操作

### 4.4.2 例子

属性语法解决方案的主要缺点在于，为在树中各处复制信息而衍生出大量的规则。

为在特设语法制导转换方案中解决这些问题，编译器编写者通常引入一个中央存储库，称为符号表（symbol table），用于保存有关变量的信息。这消除了在树中各处复制属性值的必要性。同时也简化了继承属性值的处理。因为语法分析器会确定求值顺序，我们无需担心破坏属性之间的依赖。

- 再论对加载操作的追踪
- 再论表达式的类型推断
- 建立抽象语法树
- 为表达式生成 ILOC
- 处理声明

## 4.5 高级主题

### 4.5.1 类型推断中更困难的问题

- 类型一致的用法和恒定类型函数
- 类型一致的用法和未知类型函数
- 类型的动态改变

### 4.5.2 改变结合性

## 4.6 小结和展望

两种进行上下文相关分析的方法：

- 属性语法
- 特设语法制导转换
