# CH11 指令选择 (Instruction Selection)

- [11.1 简介](#111-简介)
- [11.2 代码生成](#112-代码生成)
- [11.3 扩展简单的树遍历方案](#113-扩展简单的树遍历方案)
- [11.4 通过树模式匹配进行指令选择](#114-通过树模式匹配进行指令选择)
  - [11.4.1 重写规则](#1141-重写规则)
  - [11.4.2 找到平铺方案](#1142-找到平铺方案)
  - [11.4.3 工具](#1143-工具)
- [11.5 通过窥孔优化进行指令选择](#115-通过窥孔优化进行指令选择)
  - [11.5.1 窥孔优化](#1151-窥孔优化)
  - [11.5.2 窥孔变换程序](#1152-窥孔变换程序)
- [11.6 高级主题](#116-高级主题)
  - [11.6.1 学习窥孔模式](#1161-学习窥孔模式)
  - [11.6.2 生成指令序列](#1162-生成指令序列)
- [11.7 小结和展望](#117-小结和展望)

## 11.1 简介

指令选择（Instruction Selection）将编译器的 IR 映射到目标 ISA，这实际上是一个模式匹配问题。

## 11.2 代码生成

- 指令选择（Instruction Selection）
- 指令调度（Instruction Scheduling）
- 寄存器分配（Register Allocation）

## 11.3 扩展简单的树遍历方案

## 11.4 通过树模式匹配进行指令选择

给定一个 AST 和一组操作树，目标是将操作树平铺（tiling）到 AST 上，从而将 AST 映射到操作。

### 11.4.1 重写规则

编译器编写者将操作数和 AST 子树之间的关系编码为一组重写规则。

成本模型可以驱动代码生成器使之选择一个性能较好的序列。

### 11.4.2 找到平铺方案

### 11.4.3 工具

- 手工编码
- 自底向上重写系统（Bottom-Up Rewrite System, BURS）
- 文法分析技术
- 字符串模式匹配

后三种方法中，每种都有对应的工具可用于实现。

## 11.5 通过窥孔优化进行指令选择

### 11.5.1 窥孔优化

窥孔优化（Peephole Optimization）的基本前提很简单，即编译器通过考察相邻操作构成的短序列，可以高效地发现局部改进。

处理过程：展开、简化和匹配

- 识别死亡值
- 控制流操作
- 物理窗口和逻辑窗口

### 11.5.2 窥孔变换程序

大多数现代窥孔系统包含了一种工具，能够根据对目标机指令集的描述自动生成匹配程序。

GCC 使用一种名为寄存器传送语言（Register-Transfer Language, RTL）的底层 IR。后端使用一种窥孔方案将 RTL 转换为目标计算机的汇编代码。

## 11.6 高级主题

### 11.6.1 学习窥孔模式

机器学习

### 11.6.2 生成指令序列

穷举

## 11.7 小结和展望

指令选择的核心是一个模式匹配问题。
