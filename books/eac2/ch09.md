# CH09 数据流分析 (Data-Flow Analysis)

- [9.1 简介](#91-简介)
- [9.2 迭代数据流分析](#92-迭代数据流分析)
  - [9.2.1 支配性](#921-支配性)
  - [9.2.2 活动变量分析](#922-活动变量分析)
  - [9.2.3 数据流分析的局限性](#923-数据流分析的局限性)
  - [9.2.4 其他数据流问题](#924-其他数据流问题)
- [9.3 静态单赋值形式](#93-静态单赋值形式)
  - [9.3.1 构造静态单赋值形式的简单方法](#931-构造静态单赋值形式的简单方法)
  - [9.3.2 支配边界](#932-支配边界)
  - [9.3.3 放置φ函数](#933-放置φ函数)
  - [9.3.4 重命名](#934-重命名)
  - [9.3.5 从静态单赋值形式到其他形式的转换](#935-从静态单赋值形式到其他形式的转换)
  - [9.3.6 使用静态单赋值形式](#936-使用静态单赋值形式)
- [9.4 过程间分析](#94-过程间分析)
  - [9.4.1 构建调用图](#941-构建调用图)
  - [9.4.2 过程间常量传播](#942-过程间常量传播)
- [9.5 高级主题](#95-高级主题)
  - [9.5.1 结构性数据流算法和可归约性](#951-结构性数据流算法和可归约性)
  - [9.5.2 加速计算支配性的迭代框架算法的执行](#952-加速计算支配性的迭代框架算法的执行)
- [9.6 小结和展望](#96-小结和展望)

## 9.1 简介

编译器使用静态分析来确定在何处应用优化变换是安全且有利可图的。

静态分析通常从控制流分析开始，即分析代码的 IR 形式，以理解各个操作之间的控制流。控制流分析的结果是控制流图。接下来，编译器详细分析值是如何流经代码的。编译器使用分析得到的信息来寻找改进代码的机会，并证明变换的安全性。

静态单赋值形式（SSA）是一种中间表示，它在一种稀疏的数据结构中合并了控制流分析和数据流分析的结果。在分析和变换中都已经证明这种形式是有用的，它已经成为研究编译器和产品编译器中使用的一种标准表示。

## 9.2 迭代数据流分析

### 9.2.1 支配性

支配性问题迭代求解过程的关键问题：

- 可停止性
  - 集合是单调递减的
- 正确性
- 效率
  - 图的逆后序（Reverse PostOrder, RPO）遍历特别有效

### 9.2.2 活动变量分析

尽管约束 LiveOut 的方程比 Dom 的更为复杂，但其控制可停止性、正确性和效率的参数却与支配性方程颇为相似。

- 可停止性
  - 集合是单调递增的
- 正确性
- 效率

### 9.2.3 数据流分析的局限性

### 9.2.4 其他数据流问题

- 可用表达式
- 可达定义
- 可预测表达式
- 过程间综述问题

## 9.3 静态单赋值形式

将数据流和控制流均直接编码到 IR 中，以使用单趟分析来支持多种变换。

### 9.3.1 构造静态单赋值形式的简单方法

为构造程序的静态单赋值形式，编译器必须向 CFG 中的汇合点处插入 φ 函数，且必须重命名变量和临时值，使之符合支配静态单赋值形式名字空间的规则。

- 插入 φ 函数
- 重命名

最大静态单赋值形式（maximal SSA form）

半剪枝静态单赋值形式（semipruned SSA form）

### 9.3.2 支配边界

- 支配者树（Dominator Trees）
- 计算支配边界

### 9.3.3 放置φ函数

- 示例
- 效率改进

### 9.3.4 重命名

- 示例
- 效率改进
- 最终改进

### 9.3.5 从静态单赋值形式到其他形式的转换

从静态单赋值形式到其他形式的转换中，编译器可以拆分关键边，为必要的复制操作提高容身之所。而在此转换过程中出现的大部分问题都可以通过这种变换解决。但还可能出现两个更微妙的问题：

- 丢失复制问题（lost copy）：因激进的程序变换与不可拆分的关键边共同引起的
- 交换问题（swap）：因激进的程序变换与 SSA 的详细定义之间的交互所致

### 9.3.6 使用静态单赋值形式

稀疏简单常量传播（Sparse Simple Constant Propagation, SSCP）

- 复杂性
- 乐观主义：顶元素的作用
- 静态单赋值形式的值

## 9.4 过程间分析

### 9.4.1 构建调用图

- 值为过程的变量
- 根据上下文解析的名字
- 其他语言问题

### 9.4.2 过程间常量传播

- 发现常量的初始集合
- 围绕调用图传播已知的常数值
- 对值穿越过程的传输进行建模
- 算法
- 跳跃函数的实现
- 扩展算法

## 9.5 高级主题

### 9.5.1 结构性数据流算法和可归约性

除迭代算法之外，流图归约过程几乎是每个数据流算法的核心所在。

### 9.5.2 加速计算支配性的迭代框架算法的执行

在任何可归约图上，该算法将在两趟停止：第一趟计算出正确的 IDom 集合，而第二趟确认没有发生变化。而不可归约图需要超过两趟。

## 9.6 小结和展望
